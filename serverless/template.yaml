AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: "The Best Phone Service on the World"

Parameters:
  EnvironmentName:
    Type: String
    Default: demo

Globals:
  Function:
    Runtime: nodejs12.x
    Timeout: 300
    Handler: index.handler
    Environment:
      Variables:
        VOUCHER_RESULT_SQS_URL: !Sub "https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/${EnvironmentName}_voucher_result"
        VOUCHER_ORDER_SQS_URL: !Sub "https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/${EnvironmentName}_voucher_order"
        SMS_SQS_URL: !Sub "https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/${EnvironmentName}_sms"
        TWILIO_ACCOUNT_SID: xxxxxxxxxxxx
        TWILIO_ACCOUNT_AUTH: xxxx
        TWILIO_PHONE_NUMBER: "+xxx"


Resources:
  GetVoucher:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./dist/get-voucher/get-voucher.zip
      Policies:
        - SQSSendMessagePolicy:
            QueueName: !Join ["_",[!Ref EnvironmentName , "voucher_result"]]
      Events:
        VoucherOrderCome:
          Type: SQS
          Properties:
            Queue:  !GetAtt VoucherOrderQueue.Arn
            BatchSize: 1

  VoucherResultQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Join ["_",[!Ref EnvironmentName , "voucher_result"]]
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt VoucherOrderResultDeadQueue.Arn
        maxReceiveCount: 5

  VoucherOrderResultDeadQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Join ["_",[!Ref EnvironmentName , "voucher_order_result_dead"]]
      VisibilityTimeout: 300

  VoucherOrderQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Join ["_",[!Ref EnvironmentName , "voucher_order"]]
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt VoucherOrderDeadQueue.Arn
        maxReceiveCount: 5

  VoucherOrderDeadQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Join ["_",[!Ref EnvironmentName , "voucher_order_dead"]]
      VisibilityTimeout: 300

  SendSMS:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./dist/send-sms/send-sms.zip
      Policies:
        - Statement:
            - Action:
              - sns:Publish
              Effect: Allow
              Resource: "*"
      Events:
        SMSMessageCome:
          Type: SQS
          Properties:
            Queue:  !GetAtt SMSQueue.Arn
            BatchSize: 1

  SMSQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Join ["_",[!Ref EnvironmentName , "sms"]]
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt SMSDeadQueue.Arn
        maxReceiveCount: 5

  SMSDeadQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Join ["_",[!Ref EnvironmentName , "sms_dead"]]
      VisibilityTimeout: 300
